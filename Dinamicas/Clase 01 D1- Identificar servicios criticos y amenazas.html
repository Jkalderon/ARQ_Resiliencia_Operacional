<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Modelo BIA-RA</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- React & ReactDOM -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    
    <!-- Babel para JSX -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <!-- Chart.js para el Modelo RA -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>

    <!-- Estilos adicionales -->
    <style>
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .animate-fadeIn {
            animation: fadeIn 0.3s ease-out forwards;
        }
        .legend-dot {
            width: 0.75rem;
            height: 0.75rem;
            border-radius: 9999px;
            display: inline-block;
            margin-right: 0.25rem;
        }
    </style>
</head>
<body class="bg-gray-100 text-gray-800 font-sans">
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useMemo, useEffect, useRef } = React;

        // --- Constantes de Etiquetas (Labels) ---
        const SCORE_LABELS = {
            1: "Muy Bajo",
            2: "Bajo",
            3: "Medio",
            4: "Alto",
            5: "Muy Alto"
        };

        // --- Iconos SVG ---
        const IconBase = ({ children, className }) => (
            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}>
                {children}
            </svg>
        );

        const Plus = ({ className }) => <IconBase className={className}><line x1="12" y1="5" x2="12" y2="19"></line><line x1="5" y1="12" x2="19" y2="12"></line></IconBase>;
        const Trash2 = ({ className }) => <IconBase className={className}><polyline points="3 6 5 6 21 6"></polyline><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path><line x1="10" y1="11" x2="10" y2="17"></line><line x1="14" y1="11" x2="14" y2="17"></line></IconBase>;
        const AlertTriangle = ({ className }) => <IconBase className={className}><path d="M10.29 3.86L1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0z"></path><line x1="12" y1="9" x2="12" y2="13"></line><line x1="12" y1="17" x2="12.01" y2="17"></line></IconBase>;
        const BarChartIcon = ({ className }) => <IconBase className={className}><line x1="18" y1="20" x2="18" y2="10"></line><line x1="12" y1="20" x2="12" y2="4"></line><line x1="6" y1="20" x2="6" y2="14"></line></IconBase>;
        const Network = ({ className }) => <IconBase className={className}><rect x="5" y="2" width="14" height="6" rx="2" ry="2"></rect><rect x="2" y="16" width="9" height="6" rx="2" ry="2"></rect><rect x="13" y="16" width="9" height="6" rx="2" ry="2"></rect><line x1="12" y1="8" x2="12" y2="12"></line><line x1="6.5" y1="16" x2="6.5" y2="12"></line><line x1="17.5" y1="16" x2="17.5" y2="12"></line><line x1="6.5" y1="12" x2="17.5" y2="12"></line></IconBase>;
        const Users = ({ className }) => <IconBase className={className}><path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"></path><circle cx="9" cy="7" r="4"></circle><path d="M23 21v-2a4 4 0 0 0-3-3.87"></path><path d="M16 3.13a4 4 0 0 1 0 7.75"></path></IconBase>;
        const Database = ({ className }) => <IconBase className={className}><ellipse cx="12" cy="5" rx="9" ry="3"></ellipse><path d="M21 12c0 1.66-4 3-9 3s-9-1.34-9-3"></path><path d="M3 5v14c0 1.66 4 3 9 3s9-1.34 9-3V5"></path></IconBase>;
        const Building = ({ className }) => <IconBase className={className}><rect x="4" y="2" width="16" height="20" rx="2" ry="2"></rect><line x1="9" y1="22" x2="9" y2="12"></line><line x1="15" y1="12" x2="15" y2="22"></line><line x1="9" y1="12" x2="15" y2="12"></line><line x1="9" y1="6" x2="9" y2="6.01"></line><line x1="15" y1="6" x2="15" y2="6.01"></line></IconBase>;
        const Truck = ({ className }) => <IconBase className={className}><rect x="1" y="3" width="15" height="13"></rect><polygon points="16 8 20 8 23 11 23 16 16 16 16 8"></polygon><circle cx="5.5" cy="18.5" r="2.5"></circle><circle cx="18.5" cy="18.5" r="2.5"></circle></IconBase>;
        const Settings = ({ className }) => <IconBase className={className}><circle cx="12" cy="12" r="3"></circle><path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"></path></IconBase>;
        const ArrowRight = ({ className }) => <IconBase className={className}><line x1="5" y1="12" x2="19" y2="12"></line><polyline points="12 5 19 12 12 19"></polyline></IconBase>;
        const CheckCircle = ({ className }) => <IconBase className={className}><path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"></path><polyline points="22 4 12 14.01 9 11.01"></polyline></IconBase>;
        const Shield = ({ className }) => <IconBase className={className}><path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"></path></IconBase>;

        // --- Componente Principal ---
        function BIAManager() {
            // Estado navegación
            const [activeSection, setActiveSection] = useState('impact');

            // Estado BIA
            const [weights, setWeights] = useState({ financial: 40, reputational: 20, legal: 20, operational: 20 });
            const [threshold, setThreshold] = useState(50);
            const [services, setServices] = useState([
                { id: 1, name: "Servicio de Facturación", scores: { financial: 5, reputational: 3, legal: 4, operational: 3 }, dependencies: { processes: ["Cierre Contable"], people: ["Gerente Finanzas"], systems: ["SAP ERP"], infrastructure: ["Oficina Central"], suppliers: ["ISP"] } },
                { id: 2, name: "Atención al Cliente", scores: { financial: 3, reputational: 5, legal: 2, operational: 5 }, dependencies: { processes: ["Quejas"], people: ["Operadores"], systems: ["Salesforce"], infrastructure: ["Headsets"], suppliers: ["Telefonía"] } }
            ]);
            const [newService, setNewService] = useState({ name: "", scores: { financial: 1, reputational: 1, legal: 1, operational: 1 } });

            // Estado RA (Amenazas)
            const [threats, setThreats] = useState([]);
            const [newThreat, setNewThreat] = useState({
                serviceName: "", 
                dependencyType: "Procesos",
                assetName: "",
                threatName: "",
                originType: "Interna",
                category: "[N] Desastres Naturales"
            });

            // Referencia para Chart.js
            const chartRef = useRef(null);
            const chartInstance = useRef(null);

            // --- Lógica BIA ---
            const calculateWeightedScore = (scores) => {
                const rawScore = (scores.financial * weights.financial) + (scores.reputational * weights.reputational) + (scores.legal * weights.legal) + (scores.operational * weights.operational);
                return (rawScore / 5).toFixed(1);
            };

            const totalWeight = Object.values(weights).reduce((a, b) => a + b, 0);
            const isWeightsValid = totalWeight === 100;

            const criticalServices = useMemo(() => {
                return services.filter(s => parseFloat(calculateWeightedScore(s.scores)) >= threshold);
            }, [services, weights, threshold]);

            const handleAddService = () => {
                if (!newService.name) return;
                setServices([...services, { id: Date.now(), name: newService.name, scores: { ...newService.scores }, dependencies: { processes: [], people: [], systems: [], infrastructure: [], suppliers: [] } }]);
                setNewService({ name: "", scores: { financial: 1, reputational: 1, legal: 1, operational: 1 } });
            };

            const handleDeleteService = (id) => setServices(services.filter(s => s.id !== id));
            const updateDependency = (serviceId, category, value) => {
                const items = value.split(',').map(item => item.trim()).filter(item => item !== "");
                setServices(services.map(s => s.id === serviceId ? { ...s, dependencies: { ...s.dependencies, [category]: items } } : s));
            };

            // --- Lógica RA (Amenazas) ---
            const handleAddThreat = () => {
                if (!newThreat.serviceName || !newThreat.assetName || !newThreat.threatName) return;
                setThreats([...threats, {
                    id: Date.now(),
                    ...newThreat,
                    probability: 0,
                    impact: 0
                }]);
                setNewThreat({ ...newThreat, assetName: "", threatName: "" });
            };

            const updateThreatScore = (id, field, value) => {
                setThreats(threats.map(t => t.id === id ? { ...t, [field]: parseInt(value) } : t));
            };

            // --- Efecto para Chart.js ---
            useEffect(() => {
                if (activeSection === 'threats' && chartRef.current) {
                    if (chartInstance.current) {
                        chartInstance.current.destroy();
                    }

                    const riskMatrixColors = { 1: 'rgb(74, 222, 128, 0.7)', 2: 'rgb(250, 204, 21, 0.7)', 3: 'rgb(249, 115, 22, 0.7)', 4: 'rgb(220, 38, 38, 0.7)' };
                    
                    const getRiskInfo = (p, i) => {
                        const score = p * i;
                        if (score === 0) return { color: '#e5e7eb' };
                        if (score <= 4) return { color: riskMatrixColors[1] };
                        if (score <= 9) return { color: riskMatrixColors[2] };
                        if (score <= 16) return { color: riskMatrixColors[3] };
                        return { color: riskMatrixColors[4] };
                    };

                    const heatMapPlugin = {
                        id: 'heatMapGrid',
                        beforeDraw: (chart) => {
                            const ctx = chart.ctx;
                            const xAxis = chart.scales.x;
                            const yAxis = chart.scales.y;
                            const chartArea = chart.chartArea;
                            if (!xAxis || !yAxis || !chartArea) return;
                            ctx.save();
                            for (let p = 1; p <= 5; p++) {
                                for (let i = 1; i <= 5; i++) {
                                    const risk = getRiskInfo(p, i);
                                    ctx.fillStyle = risk.color;
                                    const xStart = xAxis.getPixelForValue(p - 0.5);
                                    const xEnd = xAxis.getPixelForValue(p + 0.5);
                                    const yStart = yAxis.getPixelForValue(i - 0.5);
                                    const yEnd = yAxis.getPixelForValue(i + 0.5);
                                    const width = Math.abs(xEnd - xStart);
                                    const height = Math.abs(yEnd - yStart);
                                    if (xStart < chartArea.right && xEnd > chartArea.left && yEnd < chartArea.bottom && yStart > chartArea.top) {
                                        ctx.fillRect(Math.min(xStart, xEnd), Math.min(yStart, yEnd), width, height);
                                    }
                                }
                            }
                            ctx.restore();
                        }
                    };

                    const dataPoints = threats
                        .filter(t => t.probability > 0 && t.impact > 0)
                        .map(t => ({
                            x: t.probability + (Math.random() - 0.5) * 0.15,
                            y: t.impact + (Math.random() - 0.5) * 0.15,
                            r: 8,
                            threatName: t.threatName,
                            serviceName: t.serviceName
                        }));

                    const ctx = chartRef.current.getContext('2d');
                    chartInstance.current = new Chart(ctx, {
                        type: 'bubble',
                        data: {
                            datasets: [{
                                label: 'Amenazas',
                                data: dataPoints,
                                backgroundColor: 'rgba(30, 58, 138, 0.8)', 
                                borderColor: 'rgba(255, 255, 255, 1)',
                                borderWidth: 2
                            }]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            plugins: {
                                legend: { display: false },
                                tooltip: {
                                    callbacks: {
                                        label: (ctx) => `${ctx.raw.serviceName}: ${ctx.raw.threatName}`
                                    }
                                }
                            },
                            scales: {
                                x: { 
                                    min: 0.5, 
                                    max: 5.5, 
                                    title: { display: true, text: 'Probabilidad' }, 
                                    ticks: { 
                                        stepSize: 1,
                                        callback: (val) => val % 1 === 0 ? `${val} - ${SCORE_LABELS[val]}` : ''
                                    } 
                                },
                                y: { 
                                    min: 0.5, 
                                    max: 5.5, 
                                    title: { display: true, text: 'Impacto' }, 
                                    ticks: { 
                                        stepSize: 1,
                                        callback: (val) => val % 1 === 0 ? `${val} - ${SCORE_LABELS[val]}` : ''
                                    } 
                                }
                            }
                        },
                        plugins: [heatMapPlugin]
                    });
                }
            }, [activeSection, threats]);


            // ---- VISTA 1: IMPACTO ----
            const renderImpactSection = () => (
                <div className="space-y-6 animate-fadeIn">
                    <div className="bg-white p-6 rounded-lg shadow-sm border border-gray-200">
                        <div className="flex items-center justify-between mb-4">
                            <h3 className="text-lg font-semibold text-gray-800 flex items-center gap-2">
                                <Settings className="w-5 h-5 text-blue-600" /> Configuración de Ponderación
                            </h3>
                            <div className={`text-sm font-bold ${isWeightsValid ? 'text-green-600' : 'text-red-600'}`}>Total: {totalWeight}%</div>
                        </div>
                        <div className="grid grid-cols-4 gap-4">
                            {Object.keys(weights).map(key => (
                                <div key={key}>
                                    <label className="block text-xs font-medium text-gray-500 uppercase mb-1">{key}</label>
                                    <input type="number" className="block w-full p-2 border rounded-md" value={weights[key]} onChange={(e) => setWeights({...weights, [key]: Number(e.target.value)})} />
                                </div>
                            ))}
                        </div>
                    </div>

                    <div className="bg-white p-6 rounded-lg shadow-sm border border-gray-200">
                        <h3 className="text-lg font-semibold text-gray-800 mb-4">1. Registro y Evaluación de Productos y Servicios</h3>
                        <div className="grid grid-cols-1 md:grid-cols-6 gap-4 items-end mb-6 bg-gray-50 p-4 rounded-md">
                            <div className="md:col-span-2">
                                <label className="block text-sm font-medium text-gray-700">Producto o Servicio</label>
                                <input type="text" placeholder="Nombre del servicio" className="block w-full p-2 border rounded-md" value={newService.name} onChange={(e) => setNewService({...newService, name: e.target.value})} />
                            </div>
                            {['financial', 'reputational', 'legal', 'operational'].map(dim => (
                                <div key={dim}>
                                    <label className="block text-xs font-medium text-gray-500 uppercase truncate">{dim}</label>
                                    <select className="block w-full p-2 border rounded-md text-xs" value={newService.scores[dim]} onChange={(e) => setNewService({...newService, scores: { ...newService.scores, [dim]: Number(e.target.value) }})}>
                                        {[1,2,3,4,5].map(n => (
                                            <option key={n} value={n}>{n} - {SCORE_LABELS[n]}</option>
                                        ))}
                                    </select>
                                </div>
                            ))}
                            <button onClick={handleAddService} className="w-full bg-blue-600 text-white p-2 rounded hover:bg-blue-700 flex justify-center items-center"><Plus className="w-4 h-4" /> Agregar</button>
                        </div>

                        <table className="min-w-full divide-y divide-gray-200">
                            <thead className="bg-gray-50">
                                <tr>
                                    <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Producto - Servicio</th>
                                    <th className="px-6 py-3 text-center text-xs font-medium text-gray-500 uppercase">Impacto Total</th>
                                    <th className="px-6 py-3"></th>
                                </tr>
                            </thead>
                            <tbody className="divide-y divide-gray-200">
                                {services.map(s => {
                                    const score = calculateWeightedScore(s.scores);
                                    return (
                                        <tr key={s.id} className={parseFloat(score) >= threshold ? "bg-red-50" : ""}>
                                            <td className="px-6 py-4 text-sm font-medium text-gray-900">{s.name}</td>
                                            <td className="px-6 py-4 text-center text-sm">
                                                <span className={`px-2 py-1 rounded-full text-xs font-bold ${parseFloat(score) >= 50 ? 'bg-red-100 text-red-800' : 'bg-green-100 text-green-800'}`}>{score}%</span>
                                            </td>
                                            <td className="px-6 py-4 text-right"><button onClick={() => handleDeleteService(s.id)} className="text-red-600"><Trash2 className="w-4 h-4" /></button></td>
                                        </tr>
                                    );
                                })}
                            </tbody>
                        </table>
                    </div>
                    
                    <div className="bg-blue-50 p-4 rounded-lg flex justify-between items-center">
                        <div className="flex items-center gap-2 text-blue-900 font-bold"><AlertTriangle className="w-5 h-5" /> Umbral de Criticidad</div>
                        <div className="flex items-center gap-4">
                            <input type="range" min="0" max="100" value={threshold} onChange={(e) => setThreshold(Number(e.target.value))} className="w-48" />
                            <span className="font-bold text-blue-800">{threshold}%</span>
                        </div>
                    </div>
                </div>
            );

            // ---- VISTA 2: DEPENDENCIAS ----
            const renderDependenciesSection = () => (
                <div className="space-y-6 animate-fadeIn">
                    <div className="bg-white p-6 rounded-lg shadow-sm border border-gray-200">
                        <h3 className="text-lg font-semibold text-gray-800 mb-2">2. Análisis de Dependencias</h3>
                        <p className="text-sm text-gray-600">Servicios críticos sobre el umbral ({threshold}%). Defina sus dependencias.</p>
                    </div>
                    <div className="grid grid-cols-1 gap-6 overflow-x-auto pb-4">
                        {criticalServices.length === 0 ? <div className="p-8 text-center text-gray-500 border-dashed border-2 rounded">No hay servicios críticos.</div> : 
                        <div className="flex gap-6">
                            {criticalServices.map(s => (
                                <div key={s.id} className="min-w-[300px] bg-white rounded-lg shadow border-t-4 border-blue-600 p-4 space-y-3">
                                    <h4 className="font-bold text-gray-800">{s.name}</h4>
                                    {['processes', 'people', 'systems', 'infrastructure', 'suppliers'].map(cat => (
                                        <div key={cat}>
                                            <label className="text-xs font-bold text-gray-700 uppercase flex gap-1 items-center">
                                                {cat === 'systems' && <Database className="w-3 h-3" />}
                                                {cat === 'people' && <Users className="w-3 h-3" />}
                                                {cat === 'infrastructure' && <Building className="w-3 h-3" />}
                                                {cat === 'suppliers' && <Truck className="w-3 h-3" />}
                                                {cat === 'processes' && <BarChartIcon className="w-3 h-3" />}
                                                {cat}
                                            </label>
                                            <textarea className="w-full text-xs p-2 border rounded" rows="2" 
                                                value={s.dependencies[cat].join(', ')} 
                                                onChange={(e) => updateDependency(s.id, cat, e.target.value)} 
                                                placeholder={`Lista de ${cat}...`}
                                            />
                                        </div>
                                    ))}
                                </div>
                            ))}
                        </div>}
                    </div>
                </div>
            );

            // ---- VISTA 3: AMENAZAS (NUEVA - MODELO RA) ----
            const renderThreatsSection = () => (
                <div className="space-y-6 animate-fadeIn">
                    <div className="bg-white p-6 rounded-lg shadow-sm border border-gray-200">
                        <h3 className="text-lg font-semibold text-gray-800 mb-2 flex items-center gap-2">
                            <Shield className="w-5 h-5 text-red-600" /> 3. Análisis de Amenazas
                        </h3>
                        <p className="text-sm text-gray-600 mb-6">Identifique y pondere las amenazas para los servicios críticos identificados anteriormente.</p>
                        
                        {/* Paso 1: Formulario de Identificación */}
                        <div className="bg-gray-50 p-4 rounded-md border border-gray-200 mb-8">
                            <h4 className="text-sm font-bold text-blue-800 mb-3 uppercase">Agregar Nueva Amenaza</h4>
                            <div className="grid grid-cols-1 md:grid-cols-3 gap-4 mb-4">
                                <div>
                                    <label className="block text-xs font-medium text-gray-600 mb-1">Servicio Crítico (Desde BIA)</label>
                                    <select 
                                        className="w-full p-2 border rounded text-sm"
                                        value={newThreat.serviceName}
                                        onChange={e => setNewThreat({...newThreat, serviceName: e.target.value})}
                                    >
                                        <option value="">-- Seleccione Servicio --</option>
                                        {criticalServices.map(s => <option key={s.id} value={s.name}>{s.name}</option>)}
                                    </select>
                                </div>
                                <div>
                                    <label className="block text-xs font-medium text-gray-600 mb-1">Dependencia (Lista RA)</label>
                                    <select 
                                        className="w-full p-2 border rounded text-sm"
                                        value={newThreat.dependencyType}
                                        onChange={e => setNewThreat({...newThreat, dependencyType: e.target.value})}
                                    >
                                        <option value="Procesos">Procesos</option>
                                        <option value="Personas">Personas</option>
                                        <option value="Sistemas">Sistemas</option>
                                        <option value="Eventos externos">Eventos externos</option>
                                    </select>
                                </div>
                                <div>
                                    <label className="block text-xs font-medium text-gray-600 mb-1">Nombre del Activo/Elemento</label>
                                    <input 
                                        type="text" 
                                        className="w-full p-2 border rounded text-sm"
                                        placeholder="Ej. Servidor SQL, Personal Clave..."
                                        value={newThreat.assetName}
                                        onChange={e => setNewThreat({...newThreat, assetName: e.target.value})}
                                    />
                                </div>
                                <div>
                                    <label className="block text-xs font-medium text-gray-600 mb-1">Amenaza</label>
                                    <input 
                                        type="text" 
                                        className="w-full p-2 border rounded text-sm"
                                        placeholder="Ej. Ransomware, Huelga..."
                                        value={newThreat.threatName}
                                        onChange={e => setNewThreat({...newThreat, threatName: e.target.value})}
                                    />
                                </div>
                                <div>
                                    <label className="block text-xs font-medium text-gray-600 mb-1">Tipo de Origen</label>
                                    <select 
                                        className="w-full p-2 border rounded text-sm"
                                        value={newThreat.originType}
                                        onChange={e => setNewThreat({...newThreat, originType: e.target.value})}
                                    >
                                        <option value="Interna">Interna</option>
                                        <option value="Externa">Externa</option>
                                    </select>
                                </div>
                                <div>
                                    <label className="block text-xs font-medium text-gray-600 mb-1">Categoría (MAGERIT)</label>
                                    <select 
                                        className="w-full p-2 border rounded text-sm"
                                        value={newThreat.category}
                                        onChange={e => setNewThreat({...newThreat, category: e.target.value})}
                                    >
                                        <option value="[N] Desastres Naturales">Desastres Naturales (N)</option>
                                        <option value="[I] Origen Industrial">De Origen Industrial (I)</option>
                                        <option value="[E] Errores y Fallos">Errores y Fallos (E)</option>
                                        <option value="[A] Ataques Deliberados">Ataques Deliberados (A)</option>
                                    </select>
                                </div>
                            </div>
                            <button onClick={handleAddThreat} className="w-full bg-blue-600 text-white py-2 rounded hover:bg-blue-700 text-sm font-bold flex justify-center items-center gap-2">
                                <Plus className="w-4 h-4" /> Agregar al Análisis
                            </button>
                        </div>

                        {/* Paso 2: Ponderación */}
                        <div className="mb-8">
                            <h4 className="text-sm font-bold text-blue-800 mb-3 uppercase">Ponderación de Riesgos</h4>
                            {threats.length === 0 ? (
                                <div className="text-center text-gray-400 italic border border-dashed p-4 rounded">No hay amenazas registradas.</div>
                            ) : (
                                <div className="space-y-2">
                                    {/* Cabecera solo desktop */}
                                    <div className="hidden md:grid grid-cols-12 gap-2 text-xs font-bold text-gray-500 uppercase border-b pb-2">
                                        <div className="col-span-2">Servicio</div>
                                        <div className="col-span-2">Activo</div>
                                        <div className="col-span-3">Amenaza</div>
                                        <div className="col-span-1">Tipo</div>
                                        <div className="col-span-2 text-center">Probabilidad</div>
                                        <div className="col-span-2 text-center">Impacto</div>
                                    </div>
                                    {threats.map(t => (
                                        <div key={t.id} className="grid grid-cols-1 md:grid-cols-12 gap-2 items-center bg-white border p-3 rounded shadow-sm text-sm">
                                            <div className="md:col-span-2 font-bold text-blue-900">{t.serviceName}</div>
                                            <div className="md:col-span-2 text-gray-700">{t.assetName} <span className="text-xs text-gray-400 block">{t.dependencyType}</span></div>
                                            <div className="md:col-span-3 text-gray-800">{t.threatName}</div>
                                            <div className="md:col-span-1"><span className="text-xs bg-gray-100 px-2 py-1 rounded">{t.originType}</span></div>
                                            <div className="md:col-span-2">
                                                <label className="md:hidden text-xs font-bold">Probabilidad:</label>
                                                <select className="w-full p-1 border rounded text-xs" value={t.probability} onChange={(e) => updateThreatScore(t.id, 'probability', e.target.value)}>
                                                    <option value="0">-</option>
                                                    {[1,2,3,4,5].map(n => (
                                                        <option key={n} value={n}>{n} - {SCORE_LABELS[n]}</option>
                                                    ))}
                                                </select>
                                            </div>
                                            <div className="md:col-span-2">
                                                <label className="md:hidden text-xs font-bold">Impacto:</label>
                                                <select className="w-full p-1 border rounded text-xs" value={t.impact} onChange={(e) => updateThreatScore(t.id, 'impact', e.target.value)}>
                                                    <option value="0">-</option>
                                                    {[1,2,3,4,5].map(n => (
                                                        <option key={n} value={n}>{n} - {SCORE_LABELS[n]}</option>
                                                    ))}
                                                </select>
                                            </div>
                                        </div>
                                    ))}
                                </div>
                            )}
                        </div>

                        {/* Paso 3: Visualización (Chart.js + Roadmap) */}
                        {threats.some(t => t.probability > 0 && t.impact > 0) && (
                            <div className="grid grid-cols-1 lg:grid-cols-2 gap-8 border-t pt-6">
                                <div>
                                    <h4 className="font-bold text-gray-800 mb-2 text-center">Mapa de Calor de Riesgos</h4>
                                    <div className="relative h-64 w-full">
                                        <canvas ref={chartRef}></canvas>
                                    </div>
                                    <div className="flex flex-wrap justify-center gap-3 mt-2 text-xs">
                                        <span className="flex items-center"><span className="legend-dot bg-green-500"></span>Bajo</span>
                                        <span className="flex items-center"><span className="legend-dot bg-yellow-400"></span>Mod.</span>
                                        <span className="flex items-center"><span className="legend-dot bg-orange-500"></span>Alto</span>
                                        <span className="flex items-center"><span className="legend-dot bg-red-600"></span>Crít.</span>
                                    </div>
                                </div>
                                <div>
                                    <h4 className="font-bold text-gray-800 mb-4 text-center">Hoja de Ruta de Atención</h4>
                                    <div className="bg-gray-50 p-4 rounded h-64 overflow-y-auto border">
                                        {threats
                                            .filter(t => t.probability * t.impact > 0)
                                            .map(t => ({...t, risk: t.probability * t.impact}))
                                            .sort((a,b) => b.risk - a.risk)
                                            .map((t, i) => (
                                                <div key={i} className="mb-3 p-3 bg-white border rounded shadow-sm flex justify-between items-center">
                                                    <div>
                                                        <div className="text-xs font-bold text-blue-600">{t.serviceName}</div>
                                                        <div className="font-bold text-gray-800">{t.threatName}</div>
                                                        <div className="text-xs text-gray-500">{t.assetName}</div>
                                                    </div>
                                                    <div className={`px-3 py-1 rounded font-bold text-white text-xs ${
                                                        t.risk >= 17 ? 'bg-red-600' : t.risk >= 10 ? 'bg-orange-500' : t.risk >= 5 ? 'bg-yellow-400' : 'bg-green-500'
                                                    }`}>
                                                        Riesgo: {t.risk}
                                                    </div>
                                                </div>
                                            ))
                                        }
                                    </div>
                                </div>
                            </div>
                        )}
                    </div>
                </div>
            );

            // ---- VISTA 4: RESUMEN ----
            const renderSummarySection = () => {
                // 1. Lógica de Interdependencias
                const dependencyMap = {};
                
                criticalServices.forEach(service => {
                    ['systems', 'infrastructure', 'suppliers', 'people', 'processes'].forEach(cat => {
                        service.dependencies[cat].forEach(item => {
                            const key = `${cat}|${item}`;
                            if (!dependencyMap[key]) {
                                dependencyMap[key] = { type: cat, name: item, services: [] };
                            }
                            dependencyMap[key].services.push(service.name);
                        });
                    });
                });

                const sharedDependencies = Object.values(dependencyMap).filter(d => d.services.length > 1);

                return (
                    <div className="space-y-6 animate-fadeIn">
                        {/* 4.1 Resumen de Interdependencias Críticas */}
                        <div className="bg-white p-6 rounded-lg shadow-sm border border-gray-200">
                            <h3 className="text-lg font-semibold text-gray-800 mb-4 flex items-center gap-2">
                                <Network className="w-5 h-5 text-purple-600" />
                                4.1. Resumen de Interdependencias Críticas
                            </h3>
                            <p className="text-sm text-gray-600 mb-6">
                                Análisis de recursos compartidos entre servicios críticos. Estos elementos representan 
                                <strong> Puntos Únicos de Fallo</strong> potenciales.
                            </p>

                            <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                                {sharedDependencies.length > 0 ? sharedDependencies.map((dep, idx) => (
                                <div key={idx} className="bg-purple-50 border border-purple-200 rounded-lg p-4">
                                    <div className="flex items-center gap-2 mb-2">
                                        {dep.type === 'systems' && <Database className="w-4 h-4 text-gray-600" />}
                                        {dep.type === 'people' && <Users className="w-4 h-4 text-gray-600" />}
                                        {dep.type === 'infrastructure' && <Building className="w-4 h-4 text-gray-600" />}
                                        {dep.type === 'suppliers' && <Truck className="w-4 h-4 text-gray-600" />}
                                        {dep.type === 'processes' && <BarChartIcon className="w-4 h-4 text-gray-600" />}
                                        <span className="font-bold text-gray-800 capitalize">{dep.name}</span>
                                    </div>
                                    <div className="text-xs text-gray-500 mb-2 uppercase tracking-wider font-semibold">{dep.type}</div>
                                    <div className="text-sm text-gray-700">
                                        <span className="block text-xs text-gray-500 mb-1">Crítico para:</span>
                                        <ul className="list-disc pl-4 space-y-1">
                                            {dep.services.map(s => <li key={s}>{s}</li>)}
                                        </ul>
                                    </div>
                                </div>
                                )) : (
                                <div className="col-span-full text-center text-gray-500 italic py-4">
                                    No se detectaron dependencias compartidas entre los servicios críticos seleccionados.
                                </div>
                                )}
                            </div>
                        </div>

                        {/* 4.2 Resumen Ejecutivo */}
                        <div className="bg-white p-6 rounded-lg shadow-sm border border-gray-200">
                            <h3 className="text-lg font-semibold text-gray-800 mb-4">4.2. Resumen Ejecutivo de Riesgos</h3>
                            <p className="text-sm text-gray-600 mb-4">Consolidado de Servicios Críticos, Dependencias y sus Riesgos Asociados más altos.</p>
                            
                            <div className="overflow-x-auto">
                                <table className="min-w-full text-sm">
                                    <thead className="bg-gray-100">
                                        <tr>
                                            <th className="p-3 text-left">Servicio</th>
                                            <th className="p-3 text-center">Criticidad BIA</th>
                                            <th className="p-3 text-left">Amenaza Top Detectada</th>
                                            <th className="p-3 text-center">Nivel Riesgo</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        {criticalServices.map(s => {
                                            const serviceThreats = threats.filter(t => t.serviceName === s.name);
                                            const topThreat = serviceThreats.length > 0 
                                                ? serviceThreats.sort((a,b) => (b.probability*b.impact) - (a.probability*a.impact))[0] 
                                                : null;
                                            const topRisk = topThreat ? topThreat.probability * topThreat.impact : 0;

                                            return (
                                                <tr key={s.id} className="border-b">
                                                    <td className="p-3 font-medium">{s.name}</td>
                                                    <td className="p-3 text-center font-bold text-blue-600">{calculateWeightedScore(s.scores)}%</td>
                                                    <td className="p-3 text-gray-600">{topThreat ? topThreat.threatName : 'No evaluado'}</td>
                                                    <td className="p-3 text-center">
                                                        {topThreat ? (
                                                            <span className={`px-2 py-1 rounded-full text-xs text-white ${
                                                                topRisk >= 17 ? 'bg-red-600' : topRisk >= 10 ? 'bg-orange-500' : topRisk >= 5 ? 'bg-yellow-400' : 'bg-green-500'
                                                            }`}>
                                                                {topRisk}
                                                            </span>
                                                        ) : '-'}
                                                    </td>
                                                </tr>
                                            );
                                        })}
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                );
            };

            return (
                <div className="min-h-screen bg-gray-100 pb-10">
                    <header className="bg-white shadow-sm border-b sticky top-0 z-10">
                        <div className="max-w-7xl mx-auto px-4 h-16 flex items-center justify-between">
                            <div className="flex items-center gap-2">
                                <BarChartIcon className="w-6 h-6 text-blue-600" />
                                <h1 className="text-xl font-bold text-gray-900">Modelo Análisis de Impacto y Amenazas</h1>
                            </div>
                            <div className="text-xs md:text-sm text-gray-500">Arquitectura de Resiliencia Operacional</div>
                        </div>
                    </header>

                    <main className="max-w-7xl mx-auto px-4 mt-8">
                        {/* Navegación Actualizada */}
                        <div className="flex justify-center mb-8 overflow-x-auto">
                            <nav className="flex items-center bg-white p-1 rounded-lg shadow-sm border border-gray-200 whitespace-nowrap">
                                <button onClick={() => setActiveSection('impact')} className={`px-3 md:px-4 py-2 rounded-md text-sm font-medium flex items-center gap-2 ${activeSection === 'impact' ? 'bg-blue-100 text-blue-700' : 'text-gray-600'}`}>
                                    <AlertTriangle className="w-4 h-4" /> 1. Impacto
                                </button>
                                <ArrowRight className="w-4 h-4 text-gray-300 mx-1" />
                                <button onClick={() => setActiveSection('dependencies')} className={`px-3 md:px-4 py-2 rounded-md text-sm font-medium flex items-center gap-2 ${activeSection === 'dependencies' ? 'bg-blue-100 text-blue-700' : 'text-gray-600'}`}>
                                    <Network className="w-4 h-4" /> 2. Dependencias
                                </button>
                                <ArrowRight className="w-4 h-4 text-gray-300 mx-1" />
                                {/* NUEVA SECCIÓN */}
                                <button onClick={() => setActiveSection('threats')} className={`px-3 md:px-4 py-2 rounded-md text-sm font-medium flex items-center gap-2 ${activeSection === 'threats' ? 'bg-blue-100 text-blue-700' : 'text-gray-600'}`}>
                                    <Shield className="w-4 h-4" /> 3. Amenazas
                                </button>
                                <ArrowRight className="w-4 h-4 text-gray-300 mx-1" />
                                <button onClick={() => setActiveSection('summary')} className={`px-3 md:px-4 py-2 rounded-md text-sm font-medium flex items-center gap-2 ${activeSection === 'summary' ? 'bg-blue-100 text-blue-700' : 'text-gray-600'}`}>
                                    <CheckCircle className="w-4 h-4" /> 4. Resumen
                                </button>
                            </nav>
                        </div>

                        {activeSection === 'impact' && renderImpactSection()}
                        {activeSection === 'dependencies' && renderDependenciesSection()}
                        {activeSection === 'threats' && renderThreatsSection()}
                        {activeSection === 'summary' && renderSummarySection()}
                    </main>
                </div>
            );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<BIAManager />);
    </script>
</body>
<footer>
    <h2 style="text-align: center; color: #555555; font-weight: bold;">
    Material con fines didácticos elaborado por Julio Calderón. Derechos reservados 2025
</h2>
</footer>
</html>